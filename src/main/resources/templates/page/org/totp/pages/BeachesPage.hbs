<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Top of the Poops | Beaches</title>
    <meta name="description" content="Sewage dumps at beaches for {{year}} ">

    {{> chunks/favicons }}
    {{> chunks/meta-styles }}
    {{> chunks/meta-scripts }}
    {{> chunks/meta-leaflet }}

    {{> components/meta-opengraph title="Beaches"
            twitterImageUri=share.twitterImageUri
            description=(concat "All the sewage in bathing areas")
    }}
  <style>
    /* Desktop: height ~70% of width */
    .map-wrapper {
        position: relative;
        width: 100%;
        padding-top: 70%;
    }

    /* Mobile: height ~120% of width */
    @media (max-width: 768px) {
        .map-wrapper {
            padding-top: 120%;
        }
    }

    /* Inner map fills wrapper */
    #map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .header-overlay {
        position: absolute;
        top: 10px;
        right: 60px; /* Offset for the zoom controls */
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px; /* Space between the two boxes */
        align-items: flex-end; /* Aligns both boxes to the right */
    }

    .title-box {
        padding: 10px 20px;
        border-right: 4px solid #1e3a8a;
    }

    .header-overlay .overlay-inner {
        padding: 8px 16px; /* Reduced vertical padding */
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    #storm-title {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 800;
        color: #1e3a8a;
        letter-spacing: -0.5px;
        text-transform: uppercase;
    }

    .storm-subtitle {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .title-overlay .overlay-inner {
        padding: 10px 20px;
        text-align: right;
        border-right: 4px solid #1e3a8a; /* Accent bar matching your counts */
    }
  </style>
</head>
<body>
{{> chunks/navbar }}

{{#> components/jumbotron }}
    There were at least <em>{{numberFormat totalCount}}</em> "sewage spills"
    on to designated bathing areas in {{year}}, lasting a staggering
    {{numberFormat totalDuration.toHours}} hours
{{/components/jumbotron}}

<div class="container">
    <div class="row">
        <div class="col-12">
            <div id="map-wrapper" class="map-wrapper">
                <div id="map" class="map"  style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    <div style="display:none" data-map-attribution>
                        &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors <br/>
                        Contains OS Data &copy; Crown copyright &amp; database right 2021-2024<br/>
                        &copy; <a href="https://top-of-the-poops.org">Top of the Poops</a> 2021-2024
                    </div>
                </div>
                <div class="header-overlay">
                    <div class="overlay-inner title-box">
                        <h1 id="storm-title">Top Of The Poops</h1>
                        <div class="storm-subtitle">Beach Sewage</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            {{#> components/section title="Who is polluting beaches the most?"}}

                <p><b>Please note</b> Dwr Cymru Welsh Water did not release this bathing information, that we can find,
                    so we retrofitted it using previous
                    CSO to Bathing area information.</p>

                <div class="table-responsive">
                    <table id="table-polluter" class="table table-spills table-striped">
                        <thead>
                        <tr>
                            <td>Rank</td>
                            <td>Company</td>
                            <td>Sewage Overflows</td>
                            <td>Change</td>
                            <td>Total Duration (Hours)</td>
                            <td>Change</td>
                        </tr>
                        </thead>
                        <tbody>
                        {{#each polluterRankings}}
                            <tr>
                                <td class="align-middle">{{this.rank}}</td>
                                <td class="align-middle"><a href="{{this.company.uri}}">{{this.company.name}}</a></td>
                                <td class="align-middle">{{numberFormat this.count}}</td>
                                <td class="align-middle {{>components/class-delta this.countDelta}}">{{numberFormat
                                        this.countDelta.value}}</td>
                                <td class="align-middle">{{numberFormat this.duration.toHours}}</td>
                                <td class="align-middle {{>components/class-delta this.durationDelta}}">{{numberFormat
                                        this.durationDelta.hours}}</td>
                            </tr>
                        {{/each}}
                        </tbody>
                    </table>
                </div>
            {{/components/section}}
        </div>
    </div>

    <div class="row">
        <div class="col">
            {{#> components/section title=(concat "Beaches Ranked for " year)}}

                <p>Here are all the beaches in England and Wales that had sewage overflows in {{year}}</p>

                <div class="table-responsive">
                    <table id="table-beach" data-id="beach" class="table table-spills table-striped">
                        <thead>
                        <tr>
                            <td>Rank</td>
                            <td>Beach</td>
                            <td>Company</td>
                            <td>Sewage Dumps</td>
                            <td>Change</td>
                            <td>Duration (Hours)</td>
                            <td>Change</td>
                        </tr>
                        </thead>
                        <tbody>
                        {{#each beachRankings}}
                            <tr>
                                <td class="align-middle">{{this.rank}}</td>
                                <td class="align-middle"><a href="{{this.beach.uri}}">{{this.beach.name}}</a></td>
                                <td class="align-middle"><a href="{{this.company.uri}}">{{this.company.name}}</a></td>
                                <td class="align-middle">{{numberFormat this.count.count}}</td>
                                <td class="align-middle {{>components/class-delta this.countDelta}}">{{numberFormat
                                        this.countDelta.value}}</td>
                                <td class="align-middle">{{numberFormat this.duration.hours}}</td>
                                <td class="align-middle {{>components/class-delta this.durationDelta}}">{{numberFormat
                                        this.durationDelta.hours}}</td>
                            </tr>
                        {{/each}}
                        </tbody>
                    </table>
                </div>
            {{/components/section}}
        </div>
    </div>
</div>

<script>
    new DataTable('#table-beach',
            {
                pageLength: 20,
                dom: "<'row'<'col-md-8'p><'col-md-4'f>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-12 col-md-5'i>>"
            });
</script>

<script type="module">
    import * as utils from '/assets/js/utils.js';
    import * as maps from '/assets/js/map-common.js';

    if (L.Browser.mobile) {
        Array.from(document.getElementsByClassName("desktop-only")).forEach(it => it.remove())
    } else {
        Array.from(document.getElementsByClassName("mobile-only")).forEach(it => it.remove())
    }

    const myStyle = {
        "color": "#ff7800",
        "weight": 5,
        "opacity": 0.65
    };



    function transformBeachesToGeoJSON(data) {
        return {
            type: "FeatureCollection",
            features: data.map(item => {
                return {
                    type: "Feature",
                    geometry: {type: "Point", coordinates: [item.lon, item.lat]},
                    properties: {
                        duration: item.total_spill_hours,
                        name: item.bathing,
                        company: item.company_name,
                    }
                };
            })
        };
    }

    const map = new maplibregl.Map({
        container: 'map',
        style: maps.STYLE_URI,
        zoom: 6,
        maxZoom: 18,
    });

    map.addControl(new maplibregl.AttributionControl({
        compact: true,
        customAttribution: document.getElementById("map").querySelector("[data-map-attribution]").innerHTML
    }), 'bottom-right');

    map.scrollZoom.disable();

    if (L.Browser.mobile) {
        map.dragPan.enable()
    }

    const nav = new maplibregl.NavigationControl({
        showCompass: false,
        visualizePitch: false
    });

    map.addControl(nav, 'top-right');

    map.on('moveend', function () {
        var zoom = map.getZoom();
        var bounds = map.getBounds();

        // Get specific coordinates for the corners
        var southWest = bounds.getSouthWest();
        var northEast = bounds.getNorthEast();

        console.log("Current Zoom: " + zoom);
        console.log("SouthWest Bounds: " + southWest.toString());
        console.log("NorthEast Bounds: " + northEast.toString());
    });

    const navigateToBathing = (bathing) => {
        window.location = `/beach/${utils.toKebabCase(bathing)}`;
    }

    map.on('load', async () => {

        map.fitBounds([
                    [-8.94, 49.95], [4.98, 55.82]
                ],
                {animate: false, padding: 10, maxZoom: 16});

        // Setup Source and Layer
        map.addSource('overflow-source', {
            type: 'geojson',
            data: {type: 'FeatureCollection', features: []}
        });

        map.addLayer({
            id: 'overflow-layer',
            type: 'circle',
            source: 'overflow-source',
            layout: {
                'circle-sort-key': ['get', 'duration'], // Older/larger circles drawn on top
                'visibility': 'visible'
            },
            paint: {
                // Color by Company
                'circle-color': [
                    'match', ['get', 'company'],
                    'Anglian Water', maps.COMPANY_COLORS['Anglian Water'],
                    'Northumbrian Water', maps.COMPANY_COLORS['Northumbrian Water'],
                    'Severn Trent Water', maps.COMPANY_COLORS['Severn Trent Water'],
                    'South West Water', maps.COMPANY_COLORS['South West Water'],
                    'Southern Water', maps.COMPANY_COLORS['Southern Water'],
                    'Thames Water', maps.COMPANY_COLORS['Thames Water'],
                    'United Utilities', maps.COMPANY_COLORS['United Utilities'],
                    'Wessex Water', maps.COMPANY_COLORS['Wessex Water'],
                    'Dwr Cymru Welsh Water', maps.COMPANY_COLORS['Dwr Cymru Welsh Water'],
                    maps.COMPANY_COLORS['Default'] // Final fallback
                ],
                // Size grows with duration (min 5px, max 30px)
                'circle-radius': [
                    'interpolate',
                    ['linear'],
                    ['get', 'duration'],
                    0, 8,
                    15000, 45
                ],
                'circle-opacity': 0.6,
                'circle-stroke-width': 0.5,
                'circle-stroke-color': 'rgba(255,255,255,0.5)',
            }
        });

        fetch("/data/v1/{{year}}/spills-by-beach.json")
                .then(r => r.json())
                .then(d => transformBeachesToGeoJSON(d))
                .then(g => {
                    map.getSource("overflow-source").setData(g)
                    refit()
                });

        new ResizeObserver(() => {
            refit()
        }).observe(map.getContainer());

    });

    function refit() {
        const g = map.getSource("overflow-source")._data;
        const bb = maps.bbox(g);

        if ( bb ) {
            map.fitBounds([
                        [bb[0], bb[1]], [bb[2], bb[3]]
                    ],
                    {padding: 10, maxZoom: 16});
        }
    }

    const tooltip = new maplibregl.Popup({
        closeButton: false,
        closeOnClick: false
    });

    map.on('mousemove', 'overflow-layer', (e) => {

        const feature = e.features[0];
        const props = feature.properties;

        tooltip
                .setLngLat(e.lngLat)
                .setHTML(`${props.company} - ${props.name} - ${utils.formatNumber(props.duration,2 )} hours`)
                .addTo(map);
    });

    map.on('mouseleave', 'overflow-layer', () => {
        tooltip.remove();
    });

    // .bindTooltip(`${it.bathing} - ${formatNumber(it.total_spill_hours, 2)} hours`)
    // .on("dblclick", e => navigateToBathing(it.bathing))



</script>

<div class="container">
    <div class="row">
        <div class="col">{{> chunks/data-sources }}</div>
    </div>
</div>

{{> chunks/footer }}
</body>
</html>