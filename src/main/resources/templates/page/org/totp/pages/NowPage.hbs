<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Top of the Poops - Sewage Map of Live Sewage Overflows</title>
    <meta name="description" content="Sewage Map showing live and historic overflows in England and Wales">

    {{> chunks/favicons }}
    {{> chunks/meta-styles }}
    {{> chunks/meta-scripts }}
    {{> chunks/meta-leaflet }}

    {{> components/meta-opengraph
            title=(concat "Live Sewage | " share.text)
            description="Live Sewage Map"
            twitterImageUri=share.twitterImageUri
    }}

    <style>
        .card {
            transition: all 0.3s ease;
            border: none;
        }

        #map-section {
            padding: 0
        }

        .map-wrapper {
            position: relative;
        }

        .map-container {
            width: 100%;
            height: clamp(400px, 75vh, 1100px);
            border-radius: 8px;
            overflow: hidden;
        }

        .map-overlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.6);
            font-size: 14px;
            font-family: system-ui, sans-serif;
            cursor: pointer;
            z-index: 20;
        }

        .legend-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            /* Increase width slightly for longer names or set to 'auto' */
            min-width: 240px;
            max-width: 320px;
        }

        .legend-overlay h3 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #1e3a8a;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 5px;
        }

        .legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 12px; /* Adds a gap between name and count pill */
            white-space: nowrap; /* Forces everything onto one line */
        }
    </style>
</head>
<body>
{{> chunks/navbar }}

{{#> components/jumbotron }}
    <div class="text-center">
        Live Sewage Overflow Map
        <p class="lead">
            <span class="badge bg-primary fs-5">{{numberFormat summary.count.start}}</span> CSOs overflowing right now
        </p>
        <h4 >Total so far for {{current.year}}: {{numberFormat current.start.hours}} hours  {{> chunks/explain-duration current.start}}</h4>
    </div>
{{/components/jumbotron}}

<div class="container-fluid" id="map-section">
    <div class="col-md-12">
        <div class="map-wrapper">
            <div class="map-container" id="map"></div>
            <div id="map-overlay" class="map-overlay">
                Tap to activate map
            </div>
            <div id="info-panel" class="legend-overlay">
                <div id="info-content"></div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row mt-2">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0"><i class="bi bi-table me-2"></i>Overflow Summary by Company</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="table-stream-summary" data-id="stream-summary" class="table table-hover">
                            <thead class="table-light">
                            <tr>
                                <th>Company</th>
                                <th class="text-end">Total CSOs</th>
                                <th class="text-end">Overflowing</th>
                                <th class="text-end">Not Overflowing</th>
                            </tr>
                            </thead>
                            <tbody>
                            {{#each summary.companies}}
                                <tr>
                                    <td class="align-middle" data-company="{{this.company.name}}">
                                        <i class="bi bi-building me-1 text-muted"></i>
                                        <a href="{{this.company.uri}}">{{this.company.name}}</a>
                                    </td>
                                    <td class="text-end">{{numberFormat this.count.total}}</td>
                                    <td class="text-end fw-bold {{#if
                                            this.count.start}}text-danger{{/if}}">{{numberFormat
                                            this.count.start}}</td>
                                    <td class="text-end">{{numberFormat this.count.stop}}</td>
                                </tr>
                            {{/each}}
                            </tbody>
                            <tfoot class="table-light">
                            <tr>
                                <td><strong>Totals</strong></td>
                                <td class="text-end">{{numberFormat summary.count.total}}</td>
                                <td class="text-end fw-bold text-danger">{{numberFormat summary.count.start}}</td>
                                <td class="text-end">{{numberFormat summary.count.stop}}</td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Yorkshire Water and Scottish Water are not yet included but will be coming soon.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <div class="row">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0"><i class="bi bi-graph-up me-2"></i>How We Interpret the Data</h2>
                </div>
                <div class="card-body p-4">
                    <div class="row mb-4">
                        <div class="col-lg-8">
                            <div class="mb-4">
                                <h3 class="h5 fw-bold text-primary mb-3">Our Sophisticated Analysis Model</h3>
                                <p>You might notice that some of the figures in the above chart, particularly around
                                    how
                                    long a CSO has been overflowing, are different from the figures on other
                                    websites. We use a
                                    more sophisticated model to figure out when CSOs really started overflowing.</p>

                                <p>The water companies send a signal each time a CSO overflows, saying that it has
                                    'Started'
                                    and telling us when. Sometimes though, it sends multiple 'Started' events in a
                                    row. One
                                    event will say 'Started at 1pm', the next 'Started at 3pm', the next 'Started at
                                    10pm'...</p>

                                <p>Its clear though that despite the latest alert being 'Started at 10pm', the
                                    overflow did
                                    actually start at 1pm - so the CSO has been overflowing for far longer. This is
                                    how we
                                    keep track of the state of each CSO overflow, and why our numbers are different,
                                    we don't just rely
                                    on the latest information.</p>
                            </div>

                            <div class="alert alert-secondary">
                                <div class="d-flex">
                                    <div class="me-2">
                                        <i class="bi bi-lightbulb-fill text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <p class="mb-0">There may be errors in our interpretation... and if we find
                                            any we're committed to updating
                                            this information so that it is as accurate as possible. If you find an
                                            error, please let us
                                            know.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-body">
                                    <h4 class="h5 fw-bold text-primary mb-3">Why This Matters</h4>
                                    <p>Accurate tracking of overflow durations helps us hold water companies
                                        accountable and provides a true picture of pollution in our waterways.</p>
                                    <div class="text-center mt-4">
                                        <i class="bi bi-droplet-half text-primary" style="font-size: 3rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-light">
                                    <h3 class="h5 mb-0">Raw Data from Water Companies</h3>
                                </div>
                                <div class="card-body text-center">
                                    <figure class="figure mb-0">
                                        <img class="img-fluid rounded"
                                             src="/assets/images/stream-multiple-events.png"
                                             alt="An image showing some database records as supplied by Uk Water"/>
                                        <figcaption class="figure-caption mt-2">How we receive the data.
                                        </figcaption>
                                    </figure>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-light">
                                    <h3 class="h5 mb-0">Our Interpretation</h3>
                                </div>
                                <div class="card-body text-center">
                                    <figure class="figure mb-0">
                                        <img class="img-fluid rounded"
                                             src="/assets/images/stream-interpreted-event.png"
                                             alt="An image showing our interpretation of those records, there are far fewer"/>
                                        <figcaption class="figure-caption mt-2">After we've interpreted it.
                                        </figcaption>
                                    </figure>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">

    import * as maps from '/assets/js/map-common.js';
    import * as utils from '/assets/js/utils.js';

    const COMPANY_COLORS = maps.COMPANY_COLORS;
    const scaleFactor = window.innerWidth < 500 ? 0.5 : 1;

    const map = new maplibregl.Map({
        container: 'map',
        style: maps.STYLE_URI,
        scrollZoom: false
    });

    const sw = [-6.00, 50.00];
    const ne = [2.00, 55.65];
    const bounds = [sw, ne];

    const refit = (animate) => {
        map.fitBounds(bounds, {
            padding: 20,
            animate: animate
        });
    }

    refit(false);

    const nav = new maplibregl.NavigationControl({
        showCompass: false,
        visualizePitch: true
    });

    map.addControl(nav, 'top-right');

    let timeout;

    new ResizeObserver( e => {
        clearTimeout(timeout);
        timeout = setTimeout(() => map.resize(), 250);
    }).observe(document.getElementById("map"));

    const infoContent = document.getElementById('info-content');
    const infoPanel = document.getElementById('info-panel');

    map.on('load', async () => {

        map.addSource('rainfall-source', {
            type: 'geojson',
            data: {type: 'FeatureCollection', features: []}
        });

        map.addSource('overflow-source', {
            type: 'geojson',
            data: {type: 'FeatureCollection', features: []}
        });

        map.addLayer({
            id: 'rainfall-layer',
            type: 'fill',
            source: 'rainfall-source',
            paint: {
                'fill-color': [
                    'interpolate', ['linear'], ['get', 'rain'],
                    0, 'transparent',
                    0.1, '#93c5fd',
                    1.0, '#2563eb',
                    5.0, '#1e3a8a'
                ],
                'fill-opacity': 0.7
            }
        });

        map.addLayer({
            id: 'overflow-layer',
            type: 'circle',
            source: 'overflow-source',
            layout: {
                'circle-sort-key': ['get', 'duration'], // Older/larger circles drawn on top
                'visibility': 'visible'
            },
            paint: {
                // Color by Company
                'circle-color': [
                    'match', ['get', 'company'],
                    'Anglian Water', maps.COMPANY_COLORS['Anglian Water'],
                    'Northumbrian Water', maps.COMPANY_COLORS['Northumbrian Water'],
                    'Severn Trent Water', maps.COMPANY_COLORS['Severn Trent Water'],
                    'South West Water', maps.COMPANY_COLORS['South West Water'],
                    'Southern Water', maps.COMPANY_COLORS['Southern Water'],
                    'Thames Water', maps.COMPANY_COLORS['Thames Water'],
                    'United Utilities', maps.COMPANY_COLORS['United Utilities'],
                    'Wessex Water', maps.COMPANY_COLORS['Wessex Water'],
                    'Dwr Cymru Welsh Water', maps.COMPANY_COLORS['Dwr Cymru Welsh Water'],
                    maps.COMPANY_COLORS['Default'] // Final fallback
                ],
                'circle-radius': [
                    'interpolate',
                    ['linear'],
                    ['get', 'duration'],
                    0, 8 * scaleFactor,
                    3000, 45 * scaleFactor
                ],
                'circle-opacity': 0.6,
                'circle-stroke-width': 0.5,
                'circle-stroke-color': 'rgba(255,255,255,0.5)',
            }
        });

        map.on('mouseenter', 'overflow-layer', (e) => {
            const feature = e.features[0];
            infoContent.innerHTML = renderFeature(feature);
            infoPanel.style.display = 'block';
        });

        if (L.Browser.mobile) {

            const overlay = document.getElementById('map-overlay');

            overlay.style.display = "flex";

            map.dragPan.disable();
            map.scrollZoom.disable();
            map.boxZoom.disable();
            map.keyboard.disable();

            overlay.addEventListener("click", () => {
                overlay.style.display = "none";

                map.dragPan.enable();
                map.scrollZoom.enable();
                map.touchZoomRotate.enable();
            });

            map.on('click', (e) => {
                // radius in pixels around the touch point to search for features
                const radius = 40;

                // Create a bounding box around the click/tap point
                const bbox = [
                    [e.point.x - radius, e.point.y - radius],
                    [e.point.x + radius, e.point.y + radius]
                ];

                const features = map.queryRenderedFeatures(bbox, { layers: ['overflow-layer'] });

                if (features.length > 0) {
                    // pick the nearest feature
                    let nearest = features[0];
                    let minDistance = Infinity;

                    features.forEach(f => {
                        const fPoint = map.project(f.geometry.coordinates);
                        const dx = fPoint.x - e.point.x;
                        const dy = fPoint.y - e.point.y;
                        const dist = dx*dx + dy*dy;
                        if (dist < minDistance) {
                            nearest = f;
                            minDistance = dist;
                        }
                    });

                    // show info panel for nearest
                    infoContent.innerHTML = renderFeature(nearest);
                    infoPanel.style.display = 'block';
                }
            });
        }

        let epochMillis = new Date().getTime();

        fetch(`/live/stream/overflowing/${epochMillis}`)
                .then(r => r.json())
                .then(j => transformFlowToGeoJSON(j, epochMillis))
                .then(gj => map.getSource('overflow-source').setData(gj))
    });

    function renderFeature(feature) {
        const props = feature.properties;
        return `
        <a href="/overflow/${props.id}"><strong>${props.siteName}</strong></a><br>
        Company: ${props.company}<br/>
        <a href="/constituency/at/${props.lat}/${props.lon}?live">Constituency: ${props.pcon24nm}</a><br/>
        Continuous Duration: ${utils.formatNumber(props.duration)} hours<br>
      `
    }


    function transformFlowToGeoJSON(data, currentEpoch) {
        return {
            type: "FeatureCollection",
            features: data.map(item => {
                const startTime = new Date(item.started).getTime();
                const hoursElapsed = Math.max(0, (currentEpoch - startTime) / 3600000);

                return {
                    type: "Feature",
                    geometry: {type: "Point", coordinates: [item.loc.lon, item.loc.lat]},
                    properties: {
                        siteName: item.site_name,
                        receivingWater: item.receiving_water,
                        company: item.company,
                        pcon24nm: item.pcon24nm,
                        duration: hoursElapsed,
                        id: item.id,
                        lat: item.loc.lat,
                        lon: item.loc.lon,
                    }
                };
            })
        };
    }


</script>

{{> chunks/footer }}

</body>
</html>
