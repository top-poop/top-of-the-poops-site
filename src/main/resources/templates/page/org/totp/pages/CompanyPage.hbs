<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Top of the Poops | Company | {{ company.name }}</title>
    <meta name="description"
          content="{{ company.name }} polluted waterways {{numberFormat
                  summary.count.count}} times in {{summary.year}}">

    {{> chunks/favicons }}
    {{> chunks/meta-styles }}
    {{> chunks/meta-scripts }}
    {{> chunks/meta-leaflet }}

    <style>
        .card {
            transition: all 0.3s ease;
            border: none;
        }

        .plot-chart {
            min-height: 400px;
            border-radius: 8px;
            overflow: hidden;
        }

        .quiet-link {
            text-decoration: none;
            color: inherit;
        }

        .quiet-link:hover {
            text-decoration: none;
            color: inherit;
        }

        .leaflet-container {
            min-height: 160px;
        }

        .map-wrapper .leaflet-container {
            height: 160px !important;
        }

        .metric-card {
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 14px;
            background: #ffffff;
            transition: all .2s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
        }

        .metric-title {
            letter-spacing: .12em;
            font-size: .75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -.02em;
        }

        .metric-footer {
            font-size: .85rem;
            color: #6c757d;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        #live-summary-chart {
            width: 100%;
            height: 200px;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            #live-summary-chart {
                height: 150px;
            }
        }

    </style>

    {{> components/meta-opengraph
            title=(concat "Company | " company.name)
            twitterImageUri=share.twitterImageUri
    }}
</head>
<body>
{{> chunks/navbar }}

<div class="container-fluid py-5">
    <div class="row justify-content-md-center align-items-center g-4">
        <div class="col-md-5 offset-md-1">
            <div class="card border-0">
                <div class="card-body p-4 p-lg-5">

                    <!-- Headline -->
                    <div class="mb-4">
                        <div class="text-uppercase text-muted small fw-semibold mb-2" style="letter-spacing: .08em;">
                            EDM Data {{ summary.year }}
                        </div>

                        <h1 class="display-5 fw-bold text-dark mb-0" style="line-height: 1.1; letter-spacing: -0.5px;">
                            {{ company.name }}
                        </h1>
                    </div>

                    <hr class="my-4 opacity-25">

                    <!-- Lead Statement -->
                    <p class="fs-5 text-dark mb-5" style="max-width: 800px;">
                        In {{ summary.year }}, the company was responsible for at least
                        <span class="fw-bold fs-4">{{numberFormat summary.count.count}}</span> sewage overflows,
                        lasting a combined
                        <span class="fw-bold fs-4">{{numberFormat summary.duration.hours}}</span> hours
                        and affecting
                        <span class="fw-bold fs-4">{{numberFormat summary.locationCount}}</span> locations.
                    </p>

                    <!-- Supporting Details -->
                    <div class="row g-4">

                        <div class="col-md-4">
                            <div class="border-top pt-3">
                                <div class="text-uppercase text-muted small fw-semibold mb-2"
                                     style="letter-spacing: .08em;">
                                    Overflows
                                </div>
                                <div class="fs-2 fw-bold text-dark mb-1">
                                    {{numberFormat summary.count.count}}
                                </div>
                                <div class="text-muted small">
                                    {{> chunks/explain-count summary.count}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="border-top pt-3">
                                <div class="text-uppercase text-muted small fw-semibold mb-2"
                                     style="letter-spacing: .08em;">
                                    Duration (Hours)
                                </div>
                                <div class="fs-2 fw-bold text-dark mb-1">
                                    {{numberFormat summary.duration.hours}}
                                </div>
                                <div class="text-muted small">
                                    {{> chunks/explain-duration summary.duration}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="border-top pt-3">
                                <div class="text-uppercase text-muted small fw-semibold mb-2"
                                     style="letter-spacing: .08em;">
                                    Locations Affected
                                </div>
                                <div class="fs-2 fw-bold text-dark mb-1">
                                    {{numberFormat summary.locationCount}}
                                </div>
                                <div class="text-muted small">
                                    Across their service area
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="mt-5 pt-4 border-top">
                        {{> components/share-social share}}
                    </div>

                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0">
                <div class="card-body p-0">
                    <img class="img-fluid rounded" alt="Map showing CSO locations for {{ company.name }}"
                         src="{{ csoUri }}"/>
                </div>
            </div>
        </div>
    </div>
</div>


{{#eq company.name.value 'Scottish Water'}}
    <div class="container py-4">
        <div class="row">
            <div class="col">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <h2 class="h4 mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Special Note regarding
                            Scottish Water</h2>
                    </div>
                    <div class="card-body p-4">
                        <div class="alert alert-warning">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="bi bi-info-circle-fill fs-3"></i>
                                </div>
                                <div>
                                    <p class="mb-0">Scottish Water simply does not monitor the overflows of many of its
                                        CSOs, - so <strong>the numbers here are artificially low</strong>, the real
                                        situation is far worse.</p>
                                    <p class="mb-0 mt-2">Of the 702 CSOs locations we know about for Scottish Water,
                                        <span class="badge bg-danger">452</span> of them have <strong>ZERO</strong>
                                        reporting.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{{/eq}}

<div class="container">
    <div class="row">
        <div class="col">
            {{> chunks/plea }}
        </div>
    </div>
</div>

{{#if live}}
    <div class="container py-4">
        {{#if live.overflowing}}
            <div class="row mb-5">
                <div class="col">

                    <!-- Section Header -->
                    <div class="mb-4">
                        <div class="text-uppercase text-muted small fw-semibold mb-2" style="letter-spacing:.08em;">
                            Live Discharges
                        </div>

                        <h2 class="fw-bold text-dark mb-2">
                            {{ company.name }}
                        </h2>

                        <p class="fs-5 text-dark mb-0">
                            Currently reporting
                            <span class="fw-bold">{{ live.overflowing.length }}</span> active sewage overflows.
                            <br/>Here are the ones that have been going the longest.
                            For a full list go to the <a href="/now">live overflows page</a>
                        </p>
                    </div>

                    <hr class="opacity-25 mb-4">

                    <!-- Grid -->
                    <div class="row row-cols-1 row-cols-md-3 g-4" id="live-csos">
                        {{#each (take live.overflowing n=9)}}
                            <div class="col">
                                <a href="{{this.constituency.uri}}" class="text-decoration-none">
                                    <div class="card rounded-3 shadow-sm border-0 want-map" data-lat="{{this.loc.lat}}"
                                         data-lon="{{this.loc.lon}}">

                                        <!-- Map wrapper with fixed height -->
                                        <div class="map-wrapper">
                                            <div id="map-{{@index}}" style="height:160px; width:100%;"
                                                 class="leaflet-container w-100 rounded-top map-here"></div>
                                        </div>

                                        <div class="card-body d-flex flex-column">
                                            <h3 class="fs-5 fw-semibold mb-2">
                                                {{inc @index}}. {{this.site_name}}
                                            </h3>
                                            <div class="text-muted small mb-1">
                                                <i class="bi bi-geo-alt me-1"></i>{{this.constituency.name}}
                                            </div>
                                            <div class="text-muted small mt-auto">
                                                <i class="bi bi-clock me-1"></i>Started {{ago this.started}}
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        {{/if}}
    </div>

    <div class="container px-4 mb-4">
        <div class="mb-4">
            <div class="text-uppercase text-muted small fw-semibold mb-2 " style="letter-spacing:.08em;">
                Live data summary
            </div>

            <h1 class="fw-bold text-dark mb-2 border-bottom">{{ company.name }} </h1>

            <p class="fs-5 text-dark mb-0">
                A summary of the live overflow notifications - available since Jan 2025<br/>
                The data unfortunately is quite poor quality, so our estimates may differ from the official figures,
                when they come out. These are estimates based on {{company.name}} data
            </p>

        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="card metric-card h-100 p-4">
                    <div class="metric-title mb-3">
                        Total {{ liveSummary.lastYear.year }}<br/>
                    </div>

                    <div class="metric-value text-dark mb-3">
                        {{numberFormat liveSummary.lastYear.duration.hours}} hours
                    </div>

                    <div class="metric-footer pt-3">
                        {{> chunks/explain-duration liveSummary.lastYear.duration}}
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card metric-card h-100 p-4">
                    <div class="metric-title mb-3">
                        This year {{liveSummary.thisYear.year}} - so far
                    </div>

                    <div class="metric-value text-dark mb-3">
                        {{numberFormat liveSummary.thisYear.duration.hours}} hours
                    </div>

                    <div class="metric-footer pt-3">
                        {{> chunks/explain-duration liveSummary.thisYear.duration}}
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card metric-card h-100 p-4">
                    <div class="metric-title mb-3">
                        This month
                    </div>

                    <div class="metric-value text-dark mb-3">
                        {{ numberFormat liveSummary.currentMonth.hours }} hours
                    </div>

                    <div class="metric-footer pt-3">
                        {{> chunks/explain-duration liveSummary.currentMonth }}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col w-100 mb-5">
                <div id="live-summary-chart" data-json="{{ liveSummary.data }}"></div>
            </div>
        </div>
    </div>

    <script type="module">

        import * as Plot from "/assets/js/plot-0.6.17/plot.esm.js";
        import * as utils from "/assets/js/utils.js"

        const element = document.getElementById("live-summary-chart");
        const rect = element.getBoundingClientRect()

        function plot(data) {

            const processed = data.map(d => ({
                ...d,
                date: new Date(d.date),
                year: new Date(d.date).getFullYear().toString(),
                month: new Date(d.date).getMonth(),
                hours: d.overflowingSeconds / ( 3600 ),
            }));

            const yearColors = {
                2026: "red",
                2025: "gray",
                // 2027: "blue",
            };

            return Plot.plot({
                width: rect.width,
                height: rect.height,

                marginLeft: 10,
                marginBottom: 20,

                x: {
                    tickFormat: i => ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][i],
                    label: "Month",
                    domain: [0,11]
                },

                y: {
                    grid: true,
                    gridOpacity: 0.08,
                    tickSize: 0,
                    label: null,
                    zero: true
                },

                color: {
                    domain: Object.keys(yearColors),
                    range: Object.values(yearColors),
                    legend: true
                },

                marks: [
                    Plot.text(processed, {
                        text: d => `${utils.formatNumber(d.hours)} h`,
                        x: "month",
                        y: "hours",
                        curve: "catmull-rom",
                        z: "year",
                        dy: -15,
                    }),

                    Plot.line(processed, {
                        x: "month",
                        y: "hours",
                        curve: "catmull-rom",
                        stroke: "year",
                        strokeWidth: 3,
                        z: "year"
                    }),

                    Plot.dot(processed, {
                        x: "month",
                        y: "hours",
                        r: 6,
                        fill: "year",
                        title: d => `${d.date.toLocaleDateString("en-GB", { year: "numeric", month: "short" })} - ${utils.formatNumber(d.hours)} hours`,
                        z: "year"
                    })
                ]
            })
        }

        const data = element.dataset.json;
        if (data) {
                const json = JSON.parse(data)
                element.appendChild(plot(json));
        }
    </script>


    <script type="module">
        import * as Plot from "/assets/js/plot-0.6.17/plot.esm.js";

        const PlotDailyEDM = (data, width, height) => Plot.plot({
            marginLeft: 40,
            marginBottom: 30,
            width: width,
            height: height,
            y: {
                grid: true,
                label: "Number of CSOs ↑",
            },
            x: {
                grid: false,
            },
            marks: [
                Plot.lineY(
                        data,
                        {
                            x: d => new Date(d.date),
                            y: d => d.overflowing,
                            stroke: '#ff4444',
                            title: d => `${d.date}: ${d.overflowing} CSOs Overflowed for 30 mins or more`,
                        }
                ),
                Plot.lineY(
                        data,
                        {
                            x: d => new Date(d.date),
                            y: d => d.offline,
                            stroke: '#bbbbbb',
                            title: d => `${d.date}: ${d.offline} CSOs Offline for 30 mins or more`,
                        }
                ),
            ]
        })

        const div = document.getElementById("edm-spills");
        const rect = div.getBoundingClientRect()
        const response = await fetch(div.attributes["data-uri"].value);
        if (response.ok) {
            div.appendChild(PlotDailyEDM(await response.json(), rect.width, rect.height))
        }
    </script>

{{/if}}


<div class="container">

    <div class="mb-4">
        <div class="text-uppercase text-muted small fw-semibold mb-2 " style="letter-spacing:.08em;">
            Annual Report {{summary.year}}
        </div>

        <h1 class="fw-bold text-dark mb-2 border-bottom">{{ company.name }} </h1>
    </div>

    <div class="row mb-5">
        <div class="col">

            <div class="mb-4">
                <h4 class="fw-bold text-dark mb-2 text-muted">Worst Locations</h4>

                <p class="fs-5 text-dark mb-0">
                    The locations with the worst sewage overflows in {{summary.year}}
                </p>
            </div>

            <hr class="opacity-25 mb-4">

            <div class="row row-cols-1 row-cols-md-3 g-4" id="worst-csos">
                {{#each worstCsos}}
                    <div class="col">
                        <a href="{{this.constituency.uri}}" class="text-decoration-none">
                            <div class="card rounded-3 shadow-sm border-0 want-map" data-lat="{{this.cso.location.lat}}"
                                 data-lon="{{this.cso.location.lon}}">

                                <!-- Map wrapper -->
                                <div class="map-wrapper" style="height:160px;">
                                    <div id="worst-map-{{@index}}"
                                         class="map-here leaflet-container w-100 h-100 rounded-top"></div>
                                </div>

                                <!-- Card body -->
                                <div class="card-body d-flex flex-column">
                                    <h3 class="fs-5 fw-semibold mb-2">
                                        {{inc @index}}. {{this.cso.sitename}}
                                    </h3>

                                    <div class="text-muted small mb-1 d-flex align-items-center">
                                        <i class="bi bi-geo-alt me-1"></i>{{this.constituency.name}}
                                    </div>

                                    <div class="text-muted small mb-1 d-flex align-items-center">
                                        <i class="bi bi-water me-1"></i>{{this.cso.waterway.name}}
                                    </div>

                                    <div class="text-muted small mb-1 d-flex align-items-center">
                                        <i class="bi bi-clock-fill me-1"></i>{{numberFormat this.duration.hours}} hours
                                        <small class="text-muted ms-1">- {{> chunks/explain-duration this.duration}}</small>
                                    </div>

                                    <div class="text-muted small d-flex align-items-center mt-auto">
                                        <i class="bi bi-exclamation-circle me-1"></i>{{numberFormat this.count.count}}
                                        incidents
                                        <small class="text-muted ms-1">- {{> chunks/explain-count this.count}}</small>
                                    </div>
                                </div>

                            </div>
                        </a>
                    </div>
                {{/each}}
            </div>

        </div>
    </div>
</div>

<script type="module">
    import * as maps from '/assets/js/map-common.js';

    function createMap(mapEl, lat, lon) {
        const map = L.map(mapEl, {
            center: [lat, lon],
            zoom: 13,
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            scrollWheelZoom: false
        });

        L.tileLayer('https://top-of-the-poops.org/tiles/styles/v3/{z}/{x}/{y}.png', {
            maxZoom: 13
        }).addTo(map);

        requestAnimationFrame(() => map.invalidateSize());

        return map;
    }

    document.querySelectorAll('.want-map').forEach((card) => {
        const lat = parseFloat(card.dataset.lat);
        const lon = parseFloat(card.dataset.lon);
        if (isNaN(lat) || isNaN(lon)) return;

        // Find the child map container
        const mapEl = card.querySelector('.map-here');
        if (!mapEl) return;

        const map = createMap(mapEl, lat, lon);

        L.circleMarker([lat, lon], {
            radius: 6,
            fillColor: '#000',
            color: '#333',
            weight: 1,
            fillOpacity: 0.9
        }).addTo(map);

        const geojsonStr = card.dataset.geojson;
        if (geojsonStr) {
            const geojson = JSON.parse(geojsonStr);
            if (geojson.type === 'LineString') {
                geojson.coordinates.forEach(([lng, lat]) => {
                    L.circleMarker([lat, lng], {
                        radius: 3,
                        fillColor: 'rgba(52,83,210,0.99)',
                        color: '#2f5cd6',
                        weight: 1,
                        fillOpacity: 0.6
                    }).addTo(map);
                });
                map.fitBounds(L.latLngBounds(geojson.coordinates.map(([lng, lat]) => [lat, lng])), {padding: [5, 5]});
            }
        }
    });

    document.querySelectorAll('.want-map-bbox').forEach((card) => {

        const mapEl = card.querySelector('.map-here');
        if (!mapEl) return;

        const map = createMap(mapEl, 54.5, -3.0);

        const sw = [parseFloat(card.dataset.latsw), parseFloat(card.dataset.lonsw)];
        const ne = [parseFloat(card.dataset.latne), parseFloat(card.dataset.lonne)];
        map.fitBounds(L.latLngBounds(sw, ne));

        const geojsonStr = card.dataset.geojson;
        if (geojsonStr) {
            const geojson = JSON.parse(geojsonStr);
            if (geojson.type === 'LineString') {
                geojson.coordinates.forEach(([lng, lat]) => {
                    L.circleMarker([lat, lng], {
                        radius: 3,
                        fillColor: 'rgba(52,83,210,0.99)',
                        color: '#2f5cd6',
                        weight: 1,
                        fillOpacity: 0.6
                    }).addTo(map);
                });
            }
        }
    });

</script>


<script type="module">
    import * as Plot from "/assets/js/plot-0.6.17/plot.esm.js";

    const PlotSpillsByCompany = (data, width, height, company_name) => {
        return Plot.plot({
            // marginLeft: 100,
            // marginBottom: 30,
            width: width,
            height: height,
            y: {
                grid: true,
                zero: true,
                label: "Years of Continuous Dumping ↑",
            },
            color: {
                legend: true
            },
            x: {
                grid: false,
                domain: [2020, 2021, 2022, 2023, 2024],
                tickFormat: d => `${d}`,
            },
            marks: [
                Plot.areaY(
                        data,
                        {
                            x: "reporting_year",
                            y: (d) => d.hours / (750.5 * 12),
                            fill: "company_name",
                            tip: true,
                            opacity: 0.7,
                        }
                ),
            ]
        })
    };

    const PlotSpillsCumulative = (data, width, height, company_name) => {
        return Plot.plot({
            // marginLeft: 100,
            // marginBottom: 30,
            width: width,
            height: height,
            y: {
                grid: true,
                type: "log", base: 10,
                label: "Count of CSOs ↑",
            },
            x: {
                grid: false,
                type: "log", base: 10,
                label: "Hours of Overflow 2024 →",
            },
            color: {
                domain: [false, true],
                range: ["#ccc", "red"]
            },
            marks: [
                Plot.line(
                        data.filter(d => d["total_spill_hours"] > 0),
                        Plot.binX(
                                {y: "count", filter: null},
                                {
                                    thresholds: [1, 168 * 0.5, 168 * 1, 168 * 2, 168 * 3,
                                        1 * 730, 1.5 * 730, 2 * 730, 2.5 * 750, 3 * 730, 4 * 730, 5 * 730,
                                        6 * 730, 7 * 730, 8 * 730, 9 * 730, 10 * 730, 11 * 730, 12 * 730],

                                    z: "company_name",
                                    cumulative: -1,
                                    x: "total_spill_hours",
                                    stroke: (d) => d.company_name === company_name,
                                    sort: (d) => d.company_name === company_name ? 1 : 0
                                })
                ),
                Plot.dot(
                        data,
                        Plot.binX(
                                {y: "count", filter: null},
                                {
                                    thresholds: [1, 168 * 0.5, 168 * 1, 168 * 2, 168 * 3,
                                        1 * 730, 1.5 * 730, 2 * 730, 2.5 * 750, 3 * 730, 4 * 730, 5 * 730,
                                        6 * 730, 7 * 730, 8 * 730, 9 * 730, 10 * 730, 11 * 730, 12 * 730],
                                    z: "company_name",
                                    cumulative: -1,
                                    x: "total_spill_hours",
                                    stroke: (d) => d.company_name === company_name,
                                    sort: (d) => d.company_name === company_name ? 1 : 0,
                                    opacity: 0.7,
                                    title: (d) => d.company_name,
                                    tip: true,
                                })
                ),
                Plot.ruleX(
                        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                        {
                            stroke: "red",
                            opacity: 0.4,
                            x: d => d * 730,
                        }
                ),
                Plot.text(
                        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                        {
                            text: d => `${d} m`,
                            //textAnchor: "end",
                            rotate: 45,
                            x: d => d * 730,
                            y: 2000,
                        }
                )
            ]
        })
    };

    const div = document.getElementById("plot-company-totals");
    const response = await fetch(div.attributes["data-uri"].value);
    const rect = div.getBoundingClientRect()
    if (response.ok) {
        div.appendChild(PlotSpillsByCompany(await response.json(), rect.width, rect.height, div.attributes["data-company-name"].value))
    }

    const divc = document.getElementById("plot-company-comparison");
    const responsec = await fetch(divc.attributes["data-uri"].value);
    const rectc = divc.getBoundingClientRect()
    if (responsec.ok) {
        divc.appendChild(PlotSpillsCumulative(await responsec.json(), rectc.width, rectc.height, divc.attributes["data-company-name"].value))
    }

</script>

<div class="container py-4">
    <div class="row mb-5">
        <div class="col">

            <div class="mb-4">
                <h4 class="fw-bold text-dark mb-2 text-muted"> Rivers Polluted</h4>

                <p class="fs-5 text-dark mb-0">
                    Rivers most polluted by {{company.name}} in {{summary.year}}
                </p>
            </div>

            <hr class="opacity-25 mb-4">

            <!-- Grid of rivers -->
            <div class="row row-cols-1 row-cols-md-3 g-4" id="rivers">
                {{#each rivers}}
                    <div class="col">
                        <a href="{{this.river.uri}}" class="text-decoration-none">
                            <div class="card rounded-3 shadow-sm border-0 want-map-bbox"
                                 data-latne="{{this.bbox.ne.lat}}"
                                 data-lonne="{{this.bbox.ne.lon}}"
                                 data-latsw="{{this.bbox.sw.lat}}"
                                 data-lonsw="{{this.bbox.sw.lon}}"
                                 data-geojson="{{this.geo}}">

                                <div class="map-wrapper" style="height:160px;">
                                    <div id="river-map-{{@index}}"
                                         class="map-here leaflet-container w-100 h-100 rounded-top map-here"></div>
                                </div>

                                <div class="card-body d-flex flex-column">

                                    <h3 class="fs-5 fw-semibold mb-2">
                                        {{inc @index}}. {{this.river.name}}
                                    </h3>

                                    <div class="text-muted small mb-1 d-flex align-items-center">
                                        <i class="bi bi-clock-fill me-1"></i>{{numberFormat this.duration.hours}} hours
                                        <small class="text-muted ms-1">- {{> chunks/explain-duration this.duration}}</small>
                                    </div>

                                    <div class="text-muted small d-flex align-items-center mt-auto">
                                        <i class="bi bi-exclamation-circle me-1"></i>{{numberFormat this.count.count}}
                                        incidents
                                        <small class="text-muted ms-1">- {{> chunks/explain-count this.count}}</small>
                                    </div>
                                </div>

                            </div>
                        </a>
                    </div>
                {{/each}}
            </div>

        </div>
    </div>
</div>

{{#if beaches}}
    <div class="container py-4">
        <div class="row mb-5">
            <div class="col">

                <div class="mb-4">
                    <h4 class="fw-bold text-dark mb-2 text-muted">Beaches Polluted</h4>

                    <p class="fs-5 text-dark mb-0">
                        Beaches most polluted by  {{company.name}} in {{summary.year}}
                    </p>
                </div>

                <hr class="opacity-25 mb-4">

                <div class="row row-cols-1 row-cols-md-3 g-4" id="beaches">
                    {{#each beaches}}
                        <div class="col">
                            <a href="{{this.beach.uri}}" class="text-decoration-none">
                                <div class="card rounded-3 shadow-sm border-0 want-map"
                                     data-lat="{{this.loc.lat}}"
                                     data-lon="{{this.loc.lon}}"
                                     data-geojson="{{this.geo}}">

                                    <div class="map-wrapper" style="height:160px;">
                                        <div id="beach-map-{{@index}}"
                                             class="map-here leaflet-container w-100 h-100 rounded-top"></div>
                                    </div>

                                    <div class="card-body d-flex flex-column">
                                        <h3 class="fs-5 fw-semibold mb-2">
                                            {{inc @index}}. {{this.beach.name}}
                                        </h3>

                                        <div class="text-muted small mb-1 d-flex align-items-center">
                                            <i class="bi bi-clock-fill me-1"></i>{{numberFormat this.duration.hours}}
                                            hours
                                            <small class="text-muted ms-1">- {{> chunks/explain-duration this.duration}}</small>
                                        </div>

                                        <div class="text-muted small d-flex align-items-center mt-auto">
                                            <i class="bi bi-exclamation-circle me-1"></i>{{numberFormat
                                                this.count.count}} incidents
                                            <small class="text-muted ms-1">- {{> chunks/explain-count this.count}}</small>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    {{/each}}
                </div>

            </div>
        </div>
    </div>
{{/if}}

<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0"><i class="bi bi-graph-up me-2"></i>How many Sewage Overflows are dumping
                        sewage?</h2>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle-fill fs-3"></i>
                            </div>
                            <div>
                                <p class="mb-0">We have live data for {{company.name}} so we can track what happens
                                    every day - given
                                    that overflows are supposed to happen on an 'exceptional' basis only - does the
                                    chart
                                    indicate that?</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex flex-wrap gap-3 mb-3">
                            <div class="d-flex align-items-center">
                                    <span class="me-2"
                                          style="display:inline-block; width:20px; height:20px; background-color: #ff4444; border-radius: 4px;"></span>
                                <span>CSOs overflowing (30+ mins)</span>
                            </div>
                            <div class="d-flex align-items-center">
                                    <span class="me-2"
                                          style="display:inline-block; width:20px; height:20px; background-color: #bbbbbb; border-radius: 4px;"></span>
                                <span>CSOs offline (30+ mins)</span>
                            </div>
                        </div>

                        <p class="mb-3">There is daily updated information on all constituencies covered
                            by {{company.name}}</p>

                        <div id="edm-spills" class="plot-chart"
                             data-uri="/live/stream/company/{{company.slug}}/overflow-summary">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0"><i class="bi bi-bar-chart-fill me-2"></i>2024 - By Water Company</h2>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle-fill fs-3"></i>
                            </div>
                            <div>
                                <p class="mb-0">How does each water company compare? These are the totals by company for
                                    each. The totals are
                                    really high, counting things in hours doesn't make
                                    it very easy to think about. Here we show how many years of continuous sewage dumps
                                    happened
                                    in a single year, by water company.</p>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container mb-3">
                        <div style="height: 300px;" id="plot-company-totals" data-company-name="{{company.name}}"
                             data-uri="/data/v1/2024/spills-by-company.json"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0"><i class="bi bi-graph-up me-2"></i>2024 - Asset Spill Duration Comparison</h2>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle-fill fs-3"></i>
                            </div>
                            <div>
                                <p class="mb-0">It isn't like there are just a few outliers... the problem exists across
                                    the entire estate of water assets.
                                    Here we show a 'cumulative frequency diagram' - where the number of CSOs that dumped
                                    sewage for a time, or longer, is shown. You can see that many CSOs dumped sewage
                                    into a river for months and months.</p>

                                <p class="mb-0 mt-2"><strong>{{company.name}}</strong> is highlighted in the plot below
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container mb-3">
                        <div style="height: 300px;" id="plot-company-comparison" data-company-name="{{company.name}}"
                             data-uri="/data/v1/2024/spills-all.json"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0"><i class="bi bi-building me-2"></i>Water Companies</h2>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle-fill fs-3"></i>
                            </div>
                            <div>
                                <p class="mb-0">These water companies are responsible for managing sewage treatment and
                                    preventing pollution in our waterways.</p>
                            </div>
                        </div>
                    </div>

                    <div class="row row-cols-1 row-cols-md-4 g-4">
                        {{#each links}}
                            <div class="col-sm-4 col-lg-3">
                                {{> components/card-company this.company}}
                            </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col">{{> chunks/data-sources }}</div>
    </div>
</div>

{{> chunks/footer }}

</body>
</html>
