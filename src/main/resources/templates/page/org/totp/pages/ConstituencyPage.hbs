<html>
<head>
    <title>Constituency - {{ name.value }}</title>
    <link rel="stylesheet" href="/assets/css/leaflet.css"/>
    <script src="/assets/js/leaflet-1.9.3/leaflet.js"></script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col col-md-8">
            <div id="map" data-lat="1" data-lon="2"></div>
            <div style="display: none" id="map-geojson">
                {"type":"Polygon","coordinates":[[[-1.913681851,52.407449891],[-1.914656467,52.406740315],[-1.915310044,52.403149287],[-1.918303807,52.400119002],[-1.918585117,52.398178253],[-1.923143182,52.396210691],[-1.924390083,52.396678932],[-1.928080608,52.392876632],[-1.932866262,52.390310981],[-1.934643432,52.387875634],[-1.934322628,52.387221884],[-1.939679424,52.389585571],[-1.953621647,52.393355985],[-1.95891963,52.388233518],[-1.964934983,52.392173145],[-1.966369752,52.389450429],[-1.970554476,52.389642161],[-1.97246564,52.388111593],[-1.975585656,52.387096411],[-1.97893535,52.387857573],[-1.983632944,52.387319773],[-1.988198854,52.384488426],[-1.988979562,52.382627542],[-1.994931277,52.381099693],[-2.000126048,52.381649018],[-2.002216793,52.384185994],[-2.005009748,52.384140965],[-2.008468912,52.386948374],[-2.011361786,52.386166929],[-2.012959696,52.388686684],[-2.014192753,52.394210899],[-2.018082952,52.394935023],[-2.021365644,52.400180118],[-2.029924304,52.400632292],[-2.033648581,52.402314193],[-2.027322415,52.407099435],[-2.027542048,52.408090974],[-2.024185083,52.40635668],[-2.020485479,52.406853677],[-2.017556764,52.405568493],[-2.012685894,52.407302455],[-2.012807137,52.40949602],[-2.009245281,52.410373809],[-2.008104241,52.408605516],[-2.004646693,52.40920895],[-2.004208829,52.410954878],[-1.997799222,52.409718807],[-1.995440964,52.41256769],[-1.98886899,52.414107274],[-1.983573231,52.418130545],[-1.97502781,52.420447658],[-1.980723797,52.424654219],[-1.97535955,52.426759628],[-1.975215529,52.431732901],[-1.976499573,52.434628829],[-1.975835275,52.439013135],[-1.972978753,52.438508147],[-1.972597225,52.439427746],[-1.97344113,52.440291002],[-1.972553824,52.440576692],[-1.973187365,52.441538761],[-1.970133002,52.441937169],[-1.971057315,52.443563674],[-1.966776156,52.443517622],[-1.958929033,52.444888905],[-1.957123338,52.44383548],[-1.955862869,52.440563589],[-1.953262828,52.438383409],[-1.945609857,52.435332509],[-1.956837988,52.424151769],[-1.95472849,52.416205515],[-1.959045709,52.41409538],[-1.959128985,52.411456772],[-1.960896468,52.410953078],[-1.959576807,52.410455449],[-1.949133426,52.412821262],[-1.929911053,52.414645371],[-1.924181145,52.416564002],[-1.916942525,52.420730514],[-1.915538366,52.418363299],[-1.916900887,52.417782591],[-1.917894434,52.415651812],[-1.919755386,52.415028275],[-1.919161231,52.411925391],[-1.916674059,52.409398364],[-1.916627528,52.408359915],[-1.913681851,52.407449891]]]}
            </div>
        </div>
        <div class="col">
            <div class="card">
                <div class="card-header">Totals for {{ name.value }} in 2021</div>
                <div class="card-body">
                    <div class="card-title h5">{{summary.locationCount}} Sites polluted by {{join summary.companies
                                                                                                  ', '}}</div>
                    <div class="card-text">
                        {{summary.count}} sewage dumps<br>
                        <span class="spill-hours">{{summary.duration.toHours}} h </span>duration<br>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Take Action</div>
                <div class="card-body">
                    <div class="card-text">
                        {{> components/share-facebook uri=uri}}
                        {{> components/share-twitter uri=uri text="Hello" tags=["sewage","blah"] via="sewageuk"}}
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Explore</div>
                <div class="card-body">For information on pollution by <b>
                    <a class="card-link" href="/">River</a></b>, <b>
                    <a class="card-link" href="/">Beach</a></b> or see the worst pollution hot-spots see our
                    <a class="card-link" href="/">Homepage</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col">
            {{#> components/section title="Pollution Summary"}}
                <div class="table-responsive">
                    <table id="table-csos" class="table">
                        <thead>
                        <tr>
                            <th>Company</th>
                            <th>Waterway</th>
                            <th>Site</th>
                            <th>Sewage Dumps</th>
                            <th>Duration</th>
                            <th>Reporting %</th>
                        </tr>
                        </thead>
                        <tbody>
                        {{#each csos}}
                            <tr data-class="cso" data-lat="{{this.cso.location.lat}}"
                                data-lon="{{this.cso.location.lon}}">
                                <td>{{this.cso.company}}</td>
                                <td>{{this.cso.waterway}}</td>
                                <td data-sitename="{{this.cso.sitename}}">{{this.cso.sitename}}</td>
                                <td data-count="{{this.count}}">{{this.count}}</td>
                                <td data-duration="{{this.duration.toHours}}">{{this.duration.toHours}}</td>
                                <td>{{this.reporting}}</td>
                            </tr>
                        {{/each}}
                        </tbody>
                    </table>
                </div>
            {{/components/section}}
        </div>
    </div>
</div>

<script>
    const myStyle = {
        "color": "#ff7800",
        "weight": 5,
        "opacity": 0.65
    };

    const map = L.map("map", {scrollWheelZoom: false,});

    L.tileLayer(
            'https://maps.top-of-the-poops.org/styles/v1/{z}/{x}/{y}.png',
            {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors <br/>Contains OS Data &copy; Crown copyright &amp; database right 2021<br/>&copy; <a href="https://top-of-the-poops.org">Top of the Poops</a> 2020'
            }
    )
            .addTo(map);

    const layer = L.geoJSON(JSON.parse(document.getElementById("map-geojson").textContent), {style: myStyle});
    layer.addTo(map);
    map.fitBounds(layer.getBounds())

    const attr = (a, tr) => {
        const f = tr ? tr : (n => n);
        return n => f(n.attributes[`data-${a}`].value)
    };

    const markerIcon = (colour) => {
        return L.icon({
            iconUrl: `/assets/icons/leaflet/marker-icon-${colour}.png`,
            iconRetinaUrl: `/assets/icons/leaflet/marker-icon-2x-${colour}.png`,
            iconAnchor: [5, 55],
            popupAnchor: [10, -44],
            iconSize: [25, 41]
        })
    }

    const markerBlue = markerIcon("blue")
    const markerRed = markerIcon("red")

    const durationIcon = (n) => n > 700 ? markerRed : markerBlue;

    const lat = attr("lat", Number)
    const lon = attr("lon", Number)
    const sitename = attr("sitename")
    const count = attr("count", Number)
    const duration = attr("duration", Number)

    Array.from(document.getElementById("table-csos").querySelectorAll("tr[data-class='cso']"))
            .map(it => {
                return {
                    lat: lat(it),
                    lon: lon(it),
                    sitename: sitename(it.querySelector("[data-sitename]")),
                    count: count(it.querySelector("[data-count]")),
                    duration: duration(it.querySelector("[data-duration]"))
                }
            })
            .map(it => {
                return {
                    lat: it.lat, lon: it.lon, duration: it.duration,
                    text: `${it.sitename}<br/>xxx<br/>${it.count} Dumps / ${it.duration} hours`
                }
            })
            .map(it => L.marker([it.lat, it.lon], {icon: durationIcon(it.duration)}).bindTooltip(it.text))
            .forEach(it => it.addTo(map))
</script>
</body>
</html>