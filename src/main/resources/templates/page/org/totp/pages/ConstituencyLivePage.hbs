<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Top of the Poops | Constituency - {{#if selectedYear.current }}Live{{else}}{{ selectedYear.year }}{{/if}} Data| {{ constituency.name }}</title>
    <meta name="description" content="Live sewage dump information for {{ constituency.name }}">

    {{> chunks/favicons }}
    {{> chunks/meta-styles }}
    {{> chunks/meta-scripts }}
    {{> chunks/meta-leaflet }}

    <link rel="canonical" href="{{ uri  }}"/>

    <!-- Custom Styles -->
    <style>
        .map {
            min-height: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card {
            transition: all 0.3s ease;
            border: none;
        }
    </style>

    {{#if selectedYear.current }}
        {{> components/meta-opengraph
                title=(concat "Live Sewage | " constituency.name " | " (numberFormat summary.duration.hours) " hours so far in " selectedYear.year)
                twitterImageUri=share.twitterImageUri
        }}
    {{else}}
        {{> components/meta-opengraph
                title=(concat "Live Sewage | " constituency.name " | " (numberFormat summary.duration.hours) " hours in " selectedYear.year )
                twitterImageUri=share.twitterImageUri
        }}
    {{/if}}

</head>
<body>
{{> chunks/navbar }}

{{#> components/jumbotron }}
    <div class="text-center">
        <h1 class="display-4 fw-bold">{{ constituency.name }} - {{#if selectedYear.current }}Live{{else}}{{ selectedYear.year }}{{/if}} Sewage</h1>
        <p class="lead fs-4">
            Polluted by sewage <span class="badge bg-danger fs-5">{{numberFormat summary.duration.hours}} hours</span>
            in {{selectedYear.year}}
            {{#gt summary.duration.years 1}}
                - That's <em class="text-danger fw-bold">{{numberFormat summary.duration.years}} years</em>
            {{/gt}}
            {{#if selectedYear.current}}so far..{{/if}}
        </p>
    </div>
{{/components/jumbotron}}

<div class="container-fluid py-4">
    <div class="row g-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div id="map" class="map">
                        <div style="display:none" data-map-attribution>
                            &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors
                            <br/>
                            Contains OS Data &copy; Crown copyright &amp; database right 2021-2024<br/>
                            &copy; <a href="https://top-of-the-poops.org">Top of the Poops</a> 2021-2024
                        </div>
                    </div>
                    <div style="display: none" id="map-geojson">{{geojson}}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Which Year?</h2>
                </div>
                <div class="card-body">
                    <form>
                        <div class="form-group">
                            <label for="year-select" class="form-label fw-bold">Year</label>
                            <select class="form-select form-select-lg mb-2" name="year" id="year-select">
                                {{#each availableYears}}
                                    <option value="{{this.uri}}" {{#if this.current}}selected{{/if}}>{{this.year}}</option>
                                {{/each}}
                            </select>
                            <script>
                                document.getElementById("year-select")
                                        .onchange = (e) => {
                                    window.location = e.target.value;
                                    return false;
                                }
                            </script>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Select Another Constituency</h2>
                </div>
                <div class="card-body">
                    <form>
                        <div class="form-group">
                            <label for="constituency-select" class="form-label fw-bold">Constituency</label>
                            <select class="form-select form-select-lg mb-2" name="constituency"
                                    id="constituency-select">
                                {{#each constituencies}}
                                    <option value="{{this.uri}}" {{#if this.current}}selected{{/if}}>{{#if
                                            this.live}}
                                        ‚úî {{else}}ùë• {{/if}}{{this.name}}</option>
                                {{/each}}
                            </select>
                            <script>
                                document.getElementById("constituency-select")
                                        .onchange = (e) => {
                                    window.location = e.target.value;
                                    return false;
                                }
                            </script>
                            <div class="form-text mb-1"><i class="bi bi-info-circle me-1"></i>Select the
                                constituency
                                from the drop-down
                            </div>
                            <div class="form-text">‚úî means we have live data (ùë• if not)</div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-megaphone-fill me-2"></i>View Annual Sewage Data</h2>
                </div>
                <div class="card-body">
                    {{#if selectedYear.current }}
                        You're looking at the totals that we have calculated for sewage in {{constituency.name}} so far for {{selectedYear.year}}.
                        It is an estimate, based on very poor quality live data from the Water Companies.
                        The water companies
                        report their sewage to the Environment Agency every year in April. You can see the last reported year in the other page<br/>
                    {{else}}
                        You're looking at the totals that we have calculated for sewage in {{constituency.name}} for {{selectedYear.year}}.
                        It is an estimate, based on very poor quality live data from the Water Companies.
                        This may not align with the 'official' reported sewage values from the water companies, which is reported in April following
                        then end of the year - so 2025 numbers are reported in April 2026.
                        <br/>
                    {{/if}}

                    <a href="{{constituency.uri}}" class="text-decoration-none">
                        <button class="btn btn-danger">
                            <i class="bi bi-info-circle-fill me-1"></i>Switch to Annual Information
                        </button>
                    </a>
                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-megaphone-fill me-2"></i>Take Action</h2>
                </div>
                <div class="card-body">
                    <div class="d-flex">
                        <div class="me-2">
                            <i class="bi bi-person-fill fs-4 text-primary"></i>
                        </div>
                        <div>
                            <p class="mb-0">Your local MP is <a href="{{mp.uri}}"
                                                                class="fw-bold">{{mp.name}}</a>
                                ({{mp.party}}) - Find out more
                                about their interests, donors, and voting at <a href="{{mp.uri}}">They
                                    Work For
                                    You</a></p>
                        </div>
                    </div>

                    {{#if share}}
                        Share this page, post a message, and tell others about the huge problem of sewage pollution across the UK<br/>
                        <div class="gap-2">
                            {{> components/share-social share}}
                        </div>
                    {{/if}}

                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Constituencies
                        near {{constituency.name}}
                    </h2>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {{#each neighbours}}
                            <a href="{{this.uri}}" class="text-decoration-none">
                                <button class="btn btn-outline-secondary">
                                    <i class="bi bi-geo-fill me-1"></i> {{this.name}}
                                </button>
                            </a>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-calendar3 me-2"></i>Daily Data</h2>
                </div>
                <div class="card-body">
                    <div class="d-flex">
                        <div class="me-2">
                            <i class="bi bi-info-circle-fill fs-4 text-primary"></i>
                        </div>
                        <div>
                            <p class="mb-0">We get information about overflowing CSOs since January 2025. Here
                                is a chart of the last three months of data for {{constituency.name}}, here you
                                can see overflows in red, the darker the red,
                                the more the CSO overflowed that day.</p>
                            <p class="mb-0 mt-2">Each CSO has a row, the most recent data is on the right hand
                                side.</p>
                        </div>
                    </div>

                    <div class="plot-live observable-plot-container mb-4"
                         id="live-data"
                         cso-data-uri="{{csoUri}}"
                         rainfall-data-uri="{{rainfallUri}}">
                    </div>

                    <div class="d-flex flex-wrap gap-3 mb-3">
                        <div class="d-flex align-items-center">
                                <span class="me-2"
                                      style="display:inline-block; width:20px; height:20px; background-color: #28A64580; border-radius: 4px;"></span>
                            <span>Monitoring Online</span>
                        </div>
                        <div class="d-flex align-items-center">
                                <span class="me-2"
                                      style="display:inline-block; width:20px; height:20px; background-color: #333333; border-radius: 4px;"></span>
                            <span>Monitoring Offline</span>
                        </div>
                        <div class="d-flex align-items-center">
                                <span class="me-2"
                                      style="display:inline-block; width:20px; height:20px; background-color: #842904; border-radius: 4px;"></span>
                            <span>Polluting</span>
                        </div>
                        <div class="d-flex align-items-center">
                                <span class="me-2"
                                      style="display:inline-block; width:20px; height:20px; background-color: #460d83; border-radius: 4px;"></span>
                            <span>Potentially Polluting</span>
                        </div>
                        <div class="d-flex align-items-center">
                                <span class="me-2"
                                      style="display:inline-block; width:20px; height:20px; background-color: #3b9acb80; border-radius: 4px;"></span>
                            <span>Unknown</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Daily data is experimental and data is not guaranteed to be accurate. Please
                    inform us of any issue, we will fix.
                </div>
            </div>
        </div>
    </div>
</div>


<div class="container py-5">
    <div class="row">
        <div class="col">
            {{> chunks/plea }}
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="h5 mb-0"><i class="bi bi-calendar3 me-2"></i>Totals so far</h2>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="table-csos" class="table table-hover">
                    <thead class="table-light">
                    <tr>
                        <th>Company</th>
                        <th>Site Name</th>
                        <th>Receiving Waterway</th>
                        <th class="text-end">Overflow Days</th>
                        <th>Total Duration (hours)</th>
                        <th class="text-end">Total Duration (days)</th>
                    </tr>
                    </thead>
                    <tbody>
                    {{#each csos}}
                        <tr data-class="cso" data-lat="{{this.location.lat}}" data-lon="{{this.location.lon}}">
                            <td data-company="{{this.company.name}}" data-id="{{this.id}}">
                                <i class="bi bi-building me-1 text-muted"></i>
                                <a href="{{this.company.uri}}">{{this.company.name}}</a>
                            </td>
                            <td data-site="{{this.site_name}}">{{this.site_name}}</td>
                            <td data-water="{{this.receiving_water}}">{{this.receiving_water}}</td>

                            <td class="text-end" data-count="{{this.days.count}}">{{numberFormat this.days.count}}</td>
                            <td data-duration="{{this.duration.hours}}"
                                data-order="{{this.duration.value.toSeconds}}">{{numberFormat this.duration.hours}}
                                h {{#if
                                        this.duration.minutes}}{{this.duration.minutes}}m{{/if}}</td>
                            <td class="text-end">{{numberFormat this.duration.days}}</td>
                        </tr>
                    {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col">{{> chunks/data-sources }}</div>
    </div>
</div>

{{> chunks/footer }}

<script type="module">

    import * as maps from '/assets/js/map-common.js';

    const formatNumber = (n, m) => n.toLocaleString(undefined, {
        minimumFractionDigits: m ? m : 0,
        maximumFractionDigits: m ? m : 0
    });

    const myStyle = {
        "color": "#ff7800",
        "weight": 5,
        "opacity": 0.65
    };

    const map = L.map("map", {
        scrollWheelZoom: false,
        dragging: !L.Browser.mobile,
        tap: !L.Browser.mobile,
        maxZoom: 18,
        zoomSnap: 0.1
    });

    var gl = L.maplibreGL({
        style: maps.STYLE_URI,
        attribution: document.getElementById("map").querySelector("[data-map-attribution]").innerHTML
    }).addTo(map);
    const layer = L.geoJSON(JSON.parse(document.getElementById("map-geojson").textContent), {style: myStyle});
    layer.addTo(map);
    map.fitBounds(layer.getBounds());


    const attr = (a, tr) => {
        const attributeName = `data-${a}`
        const f = tr ? tr : (n => n);
        return n => f(n.attributes[attributeName].value)
    };

    const markerIcon = (colour) => {
        return L.icon({
            iconUrl: `/assets/icons/leaflet/marker-icon-${colour}.png`,
            iconRetinaUrl: `/assets/icons/leaflet/marker-icon-2x-${colour}.png`,
            iconAnchor: [5, 55],
            popupAnchor: [10, -44],
            iconSize: [25, 41]
        })
    }

    const markerBlue = markerIcon("blue")
    const markerRed = markerIcon("red")

    const durationIcon = (n) => {
        return n > 100 ? markerRed : markerBlue;
    }

    const lat = attr("lat", Number)
    const lon = attr("lon", Number)

    const company = attr("company")
    const id = attr("id")
    const site = attr("site")
    const count = attr("count", Number)
    const duration = attr("duration", Number)

    Array.from(document.getElementById("table-csos").querySelectorAll("tr[data-class='cso']"))
            .map(it => {
                return {
                    lat: lat(it),
                    lon: lon(it),
                    id: id(it.querySelector("[data-id]")),
                    site_name: site(it.querySelector("[data-site]")),
                    company: company(it.querySelector("[data-company]")),
                    count: count(it.querySelector("[data-count]")),
                    duration: duration(it.querySelector("[data-duration]")),
                }
            })
            .forEach(it => {
                L.marker(
                        [it.lat, it.lon],
                        {icon: durationIcon(it.duration)}
                ).bindTooltip(
                        `${it.site_name}<br/><br/>${formatNumber(it.count)} Dumps / ${formatNumber(it.duration)} hours by ${it.company}`
                ).addTo(map)
            })

    new DataTable('#table-csos', {
        pageLength: 25,
        dom:
                "<'row mb-3'<'offset-md-4 col-md-4'p><'col-md-4'f>>" +
                "<'row'<'col-sm-12't>>" +
                "<'row mt-3'<'col-sm-12 col-md-5'i>>",
    });
</script>

<script type="module">

    import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";

    const colours = {
        domain: [
            "r-0", "r-1", "r-2", "r-3", "r-4", "r-5", "r-6", "r-7", "r-8", "r-9", "r-10", // r = rainfall
            "a-0", "a-4", "a-8", "a-12", "a-16", "a-20", "a-24", // a = available (online)
            "z-0", "z-4", "z-8", "z-12", "z-16", "z-20", "z-24", // z = offline
            "o-0", "o-4", "o-8", "o-12", "o-16", "o-20", "o-24", // o = overflowing
            "p-0", "p-4", "p-8", "p-12", "p-16", "p-20", "p-24", // p = potentially overflowing
            "u-0", "u-4", "u-8", "u-12", "u-16", "u-20", "u-24", // u = unknown
        ],
        range: [
            '#ffffff', 'rgb(247,251,255)', 'rgb(225,237,248)', 'rgb(202,222,240)',
            'rgb(171,207, 230)', 'rgb(130,186,219)', 'rgb(89,161,207)', 'rgb(55,135,192)',
            'rgb(28,106,175)', 'rgb(11,77,148)', 'rgb(8,48,107)',
            "rgba(40,166,69,0.29)", "rgba(40,166,69,0.42)", "#28A64580", "#28A64580", "#28A64580", "#28A64580", "#28A64580",
            "rgba(102,102,102,0.6)", "rgba(102,102,102,0.7)", "rgba(110,110,110,0.9)", "#545454", "#444444", "#444444", "#333333",
            "#f7a974", "#fda863", "#d44a04", "#d44a04", "#d44a04", "#842904", "#842904",
            "#d4d4e8", "#d4d4e8", "#b2b1d5", "#b2b1d5", "#7363ad", "#7363ad", "#460d83",
            "rgba(59,154,203,0.24)", "rgba(59,154,203,0.28)", "rgba(59,154,203,0.36)", "#3b9acb80", "#3b9acb80", "#3b9acb80", "#3b9acb80",
        ],
    };

    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)

    const LiveDataHorizontalPlot = (data) => {

        const count = new Set(data.cso.map(it => it.p)).size + 1
        const dates = new Array(...new Set(data.cso.map(it => it.d)))

        data.rainfall.forEach(it => it.d = new Date(it.d))
        data.cso.forEach(it => it.d = new Date(it.d))

        return Plot.plot({
            color: colours,
            width: Math.max(1150, vw - 50),
            height: (5 * count + 50),
            x: {axis: null},
            y: {axis: null},
            marks: [
                Plot.raster(
                        data.cso,
                        {
                            width: dates.length,
                            height: count,
                            fill: 'a',
                        }
                ),
                Plot.axisX({
                    ticks: 8, label: "Date", tickFormat: (i) => {
                        return data.cso[i].d.toLocaleDateString();
                    }
                })
            ]
        });
    };

    const height = window.innerHeight
    const width = window.innerWidth

    const element = document.getElementById("live-data");
    const cso_data = await fetch(element.attributes["cso-data-uri"].value);
    const rainfall_data = await fetch(element.attributes["rainfall-data-uri"].value);
    if (cso_data.ok) {

        const rainfall = await (rainfall_data.ok ? rainfall_data.json() : Promise.resolve([]))

        const data = {
            "cso": await (cso_data.json()),
            "rainfall": rainfall,
        }

        element.appendChild(LiveDataHorizontalPlot(data))
        element.classList.add("horizontal")
    }
</script>


</body>
</html>
