<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Top of the Poops | Constituency - {{#if selectedYear.current }}
        Live{{else}}{{ selectedYear.year }}{{/if}} Data| {{ constituency.name }}</title>
    <meta name="description" content="Live sewage dump information for {{ constituency.name }}">

    {{> chunks/favicons }}
    {{> chunks/meta-styles }}
    {{> chunks/meta-scripts }}
    {{> chunks/meta-leaflet }}

    <link rel="canonical" href="{{ uri  }}"/>

    <style>
        .map {
            min-height: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card {
            transition: all 0.3s ease;
            border: none;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .day {
            position: relative;
            width: 20px;
            aspect-ratio: 1 / 1;
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.21);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day .inner {
            width: 60%;
            height: 60%;
            border-radius: 80%;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

    </style>

    {{#if selectedYear.current }}
        {{> components/meta-opengraph
                title=(concat "Live Sewage | " constituency.name " | " (numberFormat summary.start.hours) " hours so far in " selectedYear.year)
                twitterImageUri=share.twitterImageUri
        }}
    {{else}}
        {{> components/meta-opengraph
                title=(concat "Live Sewage | " constituency.name " | " (numberFormat summary.start.hours) " hours in " selectedYear.year )
                twitterImageUri=share.twitterImageUri
        }}
    {{/if}}

</head>
<body>
{{> chunks/navbar }}

{{#> components/jumbotron }}
    <div class="text-center">
        <h1 class="display-4 fw-bold">{{ constituency.name }} - {{#if selectedYear.current }}
            Live{{else}}{{ selectedYear.year }}{{/if}} Sewage</h1>
        <p class="lead fs-4">
            Polluted by sewage <span class="badge bg-danger fs-5">{{numberFormat summary.start.hours}} hours</span>
            in {{selectedYear.year}}

            {{#gt summary.start.years 1}}
                - That's <em class="text-danger fw-bold">{{numberFormat summary.start.years}} years</em>
            {{/gt}}

            {{#gt summary.offline.hours 1}}, monitoring offline <span class="badge bg-primary fs-5">{{numberFormat summary.offline.hours}}</span> hours{{/gt}}
            {{#gt summary.potential.hours 1}}, potential overflows <span class="badge bg-primary fs-5">{{numberFormat summary.potential.hours}}</span> hours{{/gt}}

            {{#if selectedYear.current}}so far..{{/if}}
        </p>
    </div>
{{/components/jumbotron}}

<div class="container-fluid py-4">
    <div class="row g-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div id="map" class="map">
                        <div style="display:none" data-map-attribution>
                            &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors
                            <br/>
                            Contains OS Data &copy; Crown copyright &amp; database right 2021-2024<br/>
                            &copy; <a href="https://top-of-the-poops.org">Top of the Poops</a> 2021-2024
                        </div>
                    </div>
                    <div style="display: none" id="map-geojson">{{geojson}}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Which Year?</h2>
                </div>
                <div class="card-body">
                    <form>
                        <div class="form-group">
                            <label for="year-select" class="form-label fw-bold">Year</label>
                            <select class="form-select form-select-lg mb-2" name="year" id="year-select">
                                {{#each availableYears}}
                                    <option value="{{this.uri}}"
                                            {{#if this.current}}selected{{/if}}>{{this.year}}</option>
                                {{/each}}
                            </select>
                            <script>
                                document.getElementById("year-select")
                                        .onchange = (e) => {
                                    window.location = e.target.value;
                                    return false;
                                }
                            </script>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Select Another Constituency</h2>
                </div>
                <div class="card-body">
                    <form>
                        <div class="form-group">
                            <label for="constituency-select" class="form-label fw-bold">Constituency</label>
                            <select class="form-select form-select-lg mb-2" name="constituency"
                                    id="constituency-select">
                                {{#each constituencies}}
                                    <option value="{{this.uri}}" {{#if this.current}}selected{{/if}}>{{#if
                                            this.live}}
                                        ‚úî {{else}}ùë• {{/if}}{{this.name}}</option>
                                {{/each}}
                            </select>
                            <script>
                                document.getElementById("constituency-select")
                                        .onchange = (e) => {
                                    window.location = e.target.value;
                                    return false;
                                }
                            </script>
                            <div class="form-text mb-1"><i class="bi bi-info-circle me-1"></i>Select the
                                constituency
                                from the drop-down
                            </div>
                            <div class="form-text">‚úî means we have live data (ùë• if not)</div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-megaphone-fill me-2"></i>View Annual Sewage Data</h2>
                </div>
                <div class="card-body">
                    {{#if selectedYear.current }}
                        You're looking at the totals that we have calculated for sewage in {{constituency.name}} so far
                        for {{selectedYear.year}}.
                        It is an estimate, based on very poor quality live data from the Water Companies.
                        The water companies
                        report their sewage to the Environment Agency every year in April. You can see the last reported
                        year in the other page<br/>
                    {{else}}
                        You're looking at the totals that we have calculated for sewage in {{constituency.name}}
                        for {{selectedYear.year}}.
                        It is an estimate, based on very poor quality live data from the Water Companies.
                        This may not align with the 'official' reported sewage values from the water companies, which is
                        reported in April following
                        then end of the year - so 2025 numbers are reported in April 2026.
                        <br/>
                    {{/if}}

                    <br/>
                    <p>
                        What's a potential overflow? If the CSO goes 'Offline' while its Overflowing, we don't know if
                        it stopped overflowing until we get a 'Stop' event.
                    </p>

                    <a href="{{constituency.uri}}" class="text-decoration-none">
                        <button class="btn btn-danger">
                            <i class="bi bi-info-circle-fill me-1"></i>Switch to Annual Information
                        </button>
                    </a>
                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-megaphone-fill me-2"></i>Take Action</h2>
                </div>
                <div class="card-body">
                    <div class="d-flex">
                        <div class="me-2">
                            <i class="bi bi-person-fill fs-4 text-primary"></i>
                        </div>
                        <div>
                            <p class="mb-0">Your local MP is <a href="{{mp.uri}}"
                                                                class="fw-bold">{{mp.name}}</a>
                                ({{mp.party}}) - Find out more
                                about their interests, donors, and voting at <a href="{{mp.uri}}">They
                                    Work For
                                    You</a></p>
                        </div>
                    </div>

                    {{#if share}}
                        Share this page, post a message, and tell others about the huge problem of sewage pollution
                        across the UK<br/>
                        <div class="gap-2">
                            {{> components/share-social share}}
                        </div>
                    {{/if}}

                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Constituencies
                        near {{constituency.name}}
                    </h2>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {{#each neighbours}}
                            <a href="{{this.uri}}" class="text-decoration-none">
                                <button class="btn btn-outline-secondary">
                                    <i class="bi bi-geo-fill me-1"></i> {{this.name}}
                                </button>
                            </a>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-calendar3 me-2"></i>Daily Data</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        {{#each annual.months}}
                            <div class="col-12 col-md-2">
                                <div class="card">
                                    <div class="card-header">
                                        {{ this.month }} - {{ numberFormat this.start.hours }} hours
                                        {{#if this.potential.any}}, {{ numberFormat this.potential.hours }} potential
                                        {{else}}
                                            {{#if this.offline.any }}, {{ numberFormat this.offline.hours }} offline{{/if}}
                                        {{/if}}
                                    </div>
                                    <div class="card-body">
                                        <div class="month-grid">
                                            {{#each this.days}}
                                                <div class="day {{this.rainfallClass}}"
                                                     title="{{this.date}} {{this.start.hours}} hours, {{ numberFormat this.rainfall}} mm rain {{#if this.offline.any }}, {{ numberFormat this.offline.hours }}h offline{{/if}}"
                                                     data-date="{{this.date}}">
                                                    <div class="inner {{this.sewageClass}}"></div>
                                                </div>
                                            {{/each}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {{/each}}
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Daily data is experimental and data is not guaranteed to be accurate. Please
                    inform us of any issue, we will fix.<br/>
                    Please note: We don't have rainfall data for Wales. If you know where to source it please let us know!
                </div>
            </div>
        </div>
    </div>
</div>


<div class="container py-5">
    <div class="row">
        <div class="col">
            {{> chunks/plea }}
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="h5 mb-0"><i class="bi bi-calendar3 me-2"></i>Totals so far</h2>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="table-csos" class="table table-hover">
                    <thead class="table-light">
                    <tr>
                        <th>Company</th>
                        <th>Site Name</th>
                        <th>Receiving Waterway</th>
                        <th class="text-end">Overflow Days</th>
                        <th>Total Duration (hours)</th>
                        <th>Offline/Potential Pollution</th>
                    </tr>
                    </thead>
                    <tbody>
                    {{#each csos}}
                        <tr data-class="cso" data-lat="{{this.location.lat}}" data-lon="{{this.location.lon}}">
                            <td data-company="{{this.company.name}}" data-id="{{this.id.id}}">
                                <i class="bi bi-building me-1 text-muted"></i>
                                <a href="{{this.company.uri}}">{{this.company.name}}</a>
                            </td>
                            <td data-site="{{this.site_name}}"><a href="{{this.id.uri}}">{{this.site_name}}</a></td>
                            <td data-water="{{this.receiving_water}}">{{this.receiving_water}}</td>

                            <td class="text-end" data-count="{{this.days.count}}">{{numberFormat this.days.count}}</td>
                            <td data-duration="{{this.start.hours}}"
                                data-order="{{this.start.value.toSeconds}}">{{numberFormat this.start.hours}}
                                h {{#if this.start.minutes}}{{this.start.minutes}}m{{/if}}</td>
                            <td class="text-end">{{#if this.unknown.any}}{{numberFormat this.unknown.hours}} h{{else}}-{{/if}}</td>
                        </tr>
                    {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col">{{> chunks/data-sources }}</div>
    </div>
</div>

{{> chunks/footer }}

<script type="module">

    import * as maps from '/assets/js/map-common.js';

    const formatNumber = (n, m) => n.toLocaleString(undefined, {
        minimumFractionDigits: m ? m : 0,
        maximumFractionDigits: m ? m : 0
    });

    const myStyle = {
        "color": "#ff7800",
        "weight": 5,
        "opacity": 0.65
    };

    const map = L.map("map", {
        scrollWheelZoom: false,
        dragging: !L.Browser.mobile,
        tap: !L.Browser.mobile,
        maxZoom: 18,
        zoomSnap: 0.1
    });

    var gl = L.maplibreGL({
        style: maps.STYLE_URI,
        attribution: document.getElementById("map").querySelector("[data-map-attribution]").innerHTML
    }).addTo(map);
    const layer = L.geoJSON(JSON.parse(document.getElementById("map-geojson").textContent), {style: myStyle});
    layer.addTo(map);
    map.fitBounds(layer.getBounds());


    const attr = (a, tr) => {
        const attributeName = `data-${a}`
        const f = tr ? tr : (n => n);
        return n => f(n.attributes[attributeName].value)
    };

    const markerIcon = (colour) => {
        return L.icon({
            iconUrl: `/assets/icons/leaflet/marker-icon-${colour}.png`,
            iconRetinaUrl: `/assets/icons/leaflet/marker-icon-2x-${colour}.png`,
            iconAnchor: [5, 55],
            popupAnchor: [10, -44],
            iconSize: [25, 41]
        })
    }

    const markerBlue = markerIcon("blue")
    const markerRed = markerIcon("red")

    const durationIcon = (n) => {
        return n > 100 ? markerRed : markerBlue;
    }

    const lat = attr("lat", Number)
    const lon = attr("lon", Number)

    const company = attr("company")
    const id = attr("id")
    const site = attr("site")
    const count = attr("count", Number)
    const duration = attr("duration", Number)

    Array.from(document.getElementById("table-csos").querySelectorAll("tr[data-class='cso']"))
            .map(it => {
                return {
                    lat: lat(it),
                    lon: lon(it),
                    id: id(it.querySelector("[data-id]")),
                    site_name: site(it.querySelector("[data-site]")),
                    company: company(it.querySelector("[data-company]")),
                    count: count(it.querySelector("[data-count]")),
                    duration: duration(it.querySelector("[data-duration]")),
                }
            })
            .reverse()
            .forEach(it => {
                L.marker(
                        [it.lat, it.lon],
                        {icon: durationIcon(it.duration)}
                ).bindTooltip(
                        `${it.site_name}<br/><br/>${formatNumber(it.count)} Dumps / ${formatNumber(it.duration)} hours by ${it.company}`
                ).addTo(map)
            })

    new DataTable('#table-csos', {
        pageLength: 25,
        dom:
                "<'row mb-3'<'offset-md-4 col-md-4'p><'col-md-4'f>>" +
                "<'row'<'col-sm-12't>>" +
                "<'row mt-3'<'col-sm-12 col-md-5'i>>",
    });
</script>

</body>
</html>
